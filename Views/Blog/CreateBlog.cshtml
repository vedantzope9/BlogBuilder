@model BlogBuilder.DTOs.BlogDTO
@{
    ViewData["Title"] = "CreateBlog";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
<style>
    .btn-gradient {
        background: linear-gradient(to right, #8e44ad, #5e2a7a);
        color: #fff;
        padding: 0.7rem 1.5rem;
        border-radius: 8px;
        border: none;
        transition: transform 0.3s;
    }

        .btn-gradient:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 22px rgba(142, 68, 173, 0.6);
        }
</style>

<div class="container mt-4">
    <h2 class="text-center mb-4 animate__animated animate__fadeInDown"
        style="background: linear-gradient(to right, #8e44ad, #5e2a7a);
           -webkit-background-clip: text;
           -webkit-text-fill-color: transparent;">
        ✍️ Create Your Blog
    </h2>

    <form id="createBlogForm" enctype="multipart/form-data">
        <input type="text" name="BLOG_NAME" id="blogTitle" class="form-control mb-3" placeholder="Enter Blog Title" required>
        <input type="text" name="TOPIC_NAME" id="blogTopic" class="form-control mb-3" placeholder="Enter Blog Topic" required>
        <input type="file" name="IMAGE_DATA" id="blogImage" class="form-control mb-3" accept="image/*">

        <div id="editor" style="height:300px; background:white;" class="mb-3"></div>

        <div class="text-center">
            <button type="submit" class="btn btn-gradient">Publish Blog</button>
            <a href="/Blog/Index" class="btn btn-secondary ms-2">Cancel</a>
        </div>
    </form>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", async function () {

        const jwtToken = localStorage.getItem("jwtToken");
        const userId = localStorage.getItem("userid");

        if (!jwtToken || !userId)
        {
            alert("You must be logged in to create a blog.");
            window.location.href = "/User/LoginUser";
            return;
        }

        const quill = new Quill('#editor', {
            theme: 'snow',
            placeholder: 'Start writing your blog...',
            modules: {
                toolbar: [
                    [{ 'font': [] }, { 'size': [] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    [{ 'align': [] }],
                    ['link', 'image', 'clean']
                ]
            }
        });

        const form = document.getElementById("createBlogForm");
        form.addEventListener("submit", function (e) {
            e.preventDefault();

            const formData = new FormData(form);
            formData.append("BLOG_CONTENT", quill.root.innerHTML);
            formData.append("USERID", userId);
            formData.append("isUpdated", false);

            fetch("/Blog/CreateBlog", {
                method: "POST",
                headers: { "Authorization": `Bearer ${jwtToken}` },
                body: formData
            })
            .then(res => {
                if (!res.ok) {
                    if (res.status === 401) {
                        throw new Error("Session expired. Please login again.");
                    }
                    throw new Error("Failed to create blog");
                }
                return res.text();
            })
            .then(() => {
                alert("Blog created successfully!");
                window.location.href = "/Blog/Index";
            })
            .catch(err => {
                alert("Error: " + err.message);
                if (err.message.includes("Session expired")) {
                    localStorage.clear();
                    window.location.href = "/User/LoginUser";
                }
            });
        });
    });
</script>
