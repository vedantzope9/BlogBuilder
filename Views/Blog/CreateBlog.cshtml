@model BlogBuilder.DTOs.BlogDTO
@{
    ViewData["Title"] = "Create Blog";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    :root {
        --bg-light: #fdfdfd;
        --text-light: #111;
        --bg-dark: #121212;
        --text-dark: #f1f1f1;
        --card-light: #fff;
        --card-dark: #1e1e1e;
        --accent: #7f5af0;
        --input-border: #ccc;
        --gradient: linear-gradient(to right, #7f5af0, #6246ea);
    }

    /* Light mode (default) */
    body {
        background: var(--bg-light);
        color: var(--text-light);
    }

    /* Dark mode */
    body.dark-mode {
        background: var(--bg-dark);
        color: var(--text-dark);
    }

    .theme-toggle {
        position: fixed;
        top: 1rem;
        right: 1rem;
        background: var(--gradient);
        color: white;
        border: none;
        border-radius: 6px;
        padding: 0.5rem 1rem;
        cursor: pointer;
        z-index: 1000;
    }

    .blog-container {
        max-width: 900px;
        margin: auto;
        padding: 2rem;
        font-family: 'Figtree', sans-serif;
        transition: background 0.4s, color 0.4s;
    }

    input[type="text"], input[type="file"],
    .topic-select, .topic-other,
    .ql-editor, .ql-toolbar {
        padding: 0.6rem;
        width: 100%;
        border-radius: 6px;
        border: 1px solid var(--input-border);
        background-color: var(--card-light);
        color: var(--text-light);
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    body.dark-mode input[type="text"],
    body.dark-mode input[type="file"],
    body.dark-mode .topic-select,
    body.dark-mode .topic-other,
    body.dark-mode .ql-editor,
    body.dark-mode .ql-toolbar {
        background-color: var(--card-dark);
        color: var(--text-dark);
        border-color: #444;
    }

    select option {
        background: var(--card-light);
        color: var(--text-light);
    }

    body.dark-mode select option {
        background: var(--card-dark);
        color: var(--text-dark);
    }

    .blog-title {
        text-align: center;
        font-size: 2.3rem;
        background: var(--gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 1.5rem;
    }

    .btn-submit {
        background: var(--gradient);
        color: white;
        border: none;
        padding: 0.7rem 1.5rem;
        border-radius: 8px;
        font-weight: bold;
        transition: transform 0.2s ease, box-shadow 0.2s;
    }

    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(127, 90, 240, 0.3);
    }

    .ql-container {
        min-height: 250px;
    }

    .ql-toolbar.ql-snow, .ql-container.ql-snow {
        border-radius: 6px;
    }

    #imagePreview {
        max-width: 200px;
        margin-top: 10px;
        display: none;
        border-radius: 6px;
    }

    .topic-group {
        margin-bottom: 1.2rem;
    }

    .topic-label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: block;
    }

    .topic-select, .topic-other {
        width: 100%;
        padding: 0.65rem;
        border-radius: 6px;
        border: 1px solid var(--input-border);
        background-color: inherit;
        color: inherit;
        font-size: 1rem;
        transition: border 0.2s, box-shadow 0.2s;
    }

    .topic-select:focus, .topic-other:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 5px rgba(127, 90, 240, 0.4);
    }

    .topic-other {
        margin-top: 0.7rem;
        display: none;
    }
</style>

<button class="theme-toggle" onclick="toggleTheme()">🌗 Toggle Theme</button>

<div class="blog-container">
    <h2 class="blog-title">✍️ Create Your Blog</h2>

    <form id="createBlogForm" enctype="multipart/form-data">
        <input type="text" name="BLOG_NAME" placeholder="Enter Blog Title" required />

        <!-- Blog Topic Dropdown -->
        <div class="topic-group">
            <label class="topic-label">Choose Blog Topic</label>
            <select class="topic-select" id="topicSelect" required>
                <option value="" disabled selected>-- Select a Topic --</option>
                <option value="Technology">Technology</option>
                <option value="Science">Science</option>
                <option value="Health">Health</option>
                <option value="Education">Education</option>
                <option value="Travel">Travel</option>
                <option value="Food">Food</option>
                <option value="Sports">Sports</option>
                <option value="Movies & Entertainment">Movies & Entertainment</option>
                <option value="History">History</option>
                <option value="General Knowledge">General Knowledge</option>
                <option value="Finance">Finance</option>
                <option value="Business">Business</option>
                <option value="Lifestyle">Lifestyle</option>
                <option value="Art & Culture">Art & Culture</option>
                <option value="Environment">Environment</option>
                <option value="Other">Other</option>
            </select>
            <input type="text" name="TOPIC_NAME" id="topicOther" class="topic-other" placeholder="Enter your custom topic..." />
        </div>

        <input type="file" name="image" accept="image/*" />
        <img id="imagePreview" alt="Preview" />

        <div id="editor"></div>

        <div style="text-align:center; margin-top: 1.5rem;">
            <button type="submit" class="btn-submit">🚀 Publish</button>
            <a href="/Blog/Index" class="btn btn-secondary ms-2">Cancel</a>
        </div>
    </form>
</div>

<script>
    let quill;

    document.addEventListener("DOMContentLoaded", () => {
  
        // Init Quill
        quill = new Quill('#editor', {
            theme: 'snow',
            placeholder: "Start writing your blog...",
            modules: {
                toolbar: [
                    [{ 'font': [] }, { 'size': [] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    [{ 'align': [] }],
                    ['link', 'image', 'code-block'],
                    ['clean']
                ]
            }
        });

        addClientFileValidation();
        setupTopicSelect();
        setupFormSubmit();
    });

    function toggleTheme() {
        document.body.classList.toggle("dark-mode");
        const isDark = document.body.classList.contains("dark-mode");
        localStorage.setItem("theme", isDark ? "dark" : "light");
    }

    function addClientFileValidation() {
        const fileInput = document.querySelector('input[type="file"][name="image"]');
        const preview = document.getElementById('imagePreview');
        const MAX_BYTES = 5 * 1024 * 1024;

        fileInput.addEventListener('change', (e) => {
            const f = e.target.files[0];
            if (!f) {
                // No file selected or cancel pressed
                preview.style.display = 'none';
                preview.src = '';
                return;
            }

            if (!/^image\/(png|jpe?g|webp|gif)$/i.test(f.type)) {
                alert('Please upload an image (png, jpg, webp, gif).');
                e.target.value = '';
                preview.style.display = 'none';
                return;
            }

            if (f.size > MAX_BYTES) {
                alert('Image too large. Max 5MB allowed.');
                e.target.value = '';
                preview.style.display = 'none';
                return;
            }

            // Show preview
            preview.src = URL.createObjectURL(f);
            preview.style.display = 'block';
        });
    }

    function setupTopicSelect() {
        const topicSelect = document.getElementById("topicSelect");
        const topicOther = document.getElementById("topicOther");

        topicSelect.addEventListener("change", () => {
            if (topicSelect.value === "Other") {
                topicOther.style.display = "block";
                topicOther.setAttribute("required", "required");
            } else {
                topicOther.style.display = "none";
                topicOther.removeAttribute("required");
                topicOther.value = "";
            }
        });
    }

    function setupFormSubmit() {
        const form = document.getElementById("createBlogForm");
        const jwtToken = localStorage.getItem("jwtToken");
        const userId = localStorage.getItem("userid");

        form.addEventListener("submit", function (e) {
            e.preventDefault();

            if (!jwtToken || !userId) {
                alert("Login required.");
                window.location.href = "/User/LoginUser";
                return;
            }

            const formData = new FormData(form);
            const topicSelect = document.getElementById("topicSelect");
            const topicOther = document.getElementById("topicOther");

            formData.append("BLOG_CONTENT", quill.root.innerHTML);
            formData.append("USERID", userId);
            formData.append("isUpdated", false);

            // Save proper topic
            if (topicSelect.value === "Other") {
                formData.set("TOPIC_NAME", topicOther.value);
            } else {
                formData.set("TOPIC_NAME", topicSelect.value);
            }

            fetch("/Blog/CreateBlog", {
                method: "POST",
                headers: { "Authorization": `Bearer ${jwtToken}` },
                body: formData
            })
            .then(res => {
                if (!res.ok) throw new Error("Something went wrong.");
                return res.text();
            })
            .then(() => {
                alert("Blog created!");
                window.location.href = "/Blog/Index";
            })
            .catch(err => {
                console.error(err);
                alert("Error: " + err.message);
            });
        });
    }
</script>
    